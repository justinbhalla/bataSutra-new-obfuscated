(()=>{"use strict";
// ===== Config (Sheets for tickers only)
const E="1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg",T="Headlines",R="A:C",
H=`https://docs.google.com/spreadsheets/d/${E}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(T)}&range=${encodeURIComponent(R)}`;

// Prefetch CSV early (best effort)
(function(){try{const e=document.createElement("link");e.rel="prefetch",e.href=H,e.as="fetch",e.crossOrigin="anonymous",document.head.appendChild(e)}catch{}})();

// ===== Minimal CSV parser
function p(e){const t=[],n=[];let r="",o=!1;for(let i=0;i<e.length;i++){const a=e[i];if(o)'"'===a?'"'===e[i+1]?(r+='"',i++):o=!1:r+=a;else if('"'===a)o=!0;else if(","===a)n.push(r),r="";else if("\n"===a)n.push(r),t.push(n.splice(0,n.length)),r="";else"\r"!==a&&(r+=a)}return(r.length>0||n.length>0)&&(n.push(r),t.push(n)),t}

// ===== Headlines cache (localStorage) — 15 min TTL
const C="bs_headlines_v2",L=9e5;
function g(){try{const e=localStorage.getItem(C);if(!e)return null;const{ts:t,data:n}=JSON.parse(e);return Date.now()-t>L?null:n}catch{return null}}
function y(e){try{localStorage.setItem(C,JSON.stringify({ts:Date.now(),data:e}))}catch{}}

// ===== Timeout fetch (700ms)
function f(e,t={},n=700){return new Promise(((r,o)=>{const i=new AbortController,a=setTimeout((()=>{i.abort(),o(new Error("timeout"))}),n);fetch(e,{...t,signal:i.signal,cache:"force-cache",credentials:"omit"}).then((e=>{clearTimeout(a),r(e)})).catch((e=>{clearTimeout(a),o(e)}))}))}

// ===== Quick fetcher
async function m(){try{const e=await f(H);if(!e.ok)throw new Error("HTTP "+e.status);const t=await e.text();if(t.trim().startsWith("<"))return[];const n=p(t);if(!n.length)return[];const r=n[0].map((e=>e.replace(/^\uFEFF/,"").trim().toLowerCase())),o=r.indexOf("section"),i=r.indexOf("text");return o<0||i<0?[]:n.slice(1).map((e=>({section:(e[o]||"").toLowerCase().trim(),text:(e[i]||"").trim()}))).filter((e=>e.text))}catch{return null}}

// ===== Ticker helpers
function b(e,t){const n=(t||[]).join(" • ").length||120,r=Math.min(140,Math.max(60,Math.round(n/1.8)));e.style.setProperty("--dur",r+"s")}
function v(e,t,n){if(!e||!t?.length)return; e.className=`ticker ${"right"===n?"ticker-right":"ticker-left"} ${"botTicker"===e.id?"text-sm text-slate-700":"text-sm font-medium"}`,e.innerHTML="";const r=t.concat(t);r.forEach((t=>{const n=document.createElement("span");n.textContent=t,e.appendChild(n)})),b(e,t)}
function w(e){const t=document.getElementById("topTicker"),n=document.getElementById("botTicker");if(!e)return;const r=e.filter((e=>"top"===e.section)).map((e=>e.text)),o=e.filter((e=>"bottom"===e.section)).map((e=>e.text));r.length&&v(t,r,"right"),o.length&&v(n,o,"left")}

// ===== SW (SWR for CSV)
async function S(){if(!("serviceWorker"in navigator))return;const e=`
const CACHE='bs-tickers-v1'; const HL=${JSON.stringify(H)};
self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.add(HL)).catch(()=>{})); self.skipWaiting();});
self.addEventListener('activate',e=>{self.clients.claim();});
self.addEventListener('fetch',e=>{
  const u=new URL(e.request.url);
  if(u.href===HL){
    e.respondWith((async()=>{
      const cache=await caches.open(CACHE);
      const cached=await cache.match(HL);
      const net=fetch(HL,{cache:'no-store'}).then(async r=>{ if(r.ok){ await cache.put(HL,r.clone()); postUpdate(); } return r; }).catch(()=>null);
      return cached || net || fetch(HL,{cache:'force-cache'});
    })());
  }
});
async function postUpdate(){
  const cs = await self.clients.matchAll({includeUncontrolled:true,type:'window'});
  for (const c of cs) c.postMessage({type:'bs:hl-updated'});
}`;const t=new Blob([e],{type:"text/javascript"}),n=URL.createObjectURL(t);try{await navigator.serviceWorker.register(n,{scope:"./"})}catch(e){}}

// Listen for SW updates to repaint
navigator.serviceWorker?.addEventListener?.("message",(async e=>{if("bs:hl-updated"===e?.data?.type){const e=await fetch(H,{cache:"force-cache"});if(e.ok){const t=await e.text();if(!t.trim().startsWith("<")){const e=p(t);if(e.length){const t=e[0].map((e=>e.replace(/^\uFEFF/,"").trim().toLowerCase())),n=t.indexOf("section"),r=t.indexOf("text");if(n>=0&&r>=0){const t=e.slice(1).map((e=>({section:(e[n]||"").toLowerCase().trim(),text:(e[r]||"").trim()}))).filter((e=>e.text));y(t),w(t)}}}}}}));

// ===== Boot
async function k(){
  const e=document.getElementById("year"); e && (e.textContent=(new Date).getFullYear());

  // Respect reduced motion
  try{if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches){document.querySelectorAll(".ticker-left, .ticker-right").forEach((e=>{e.style.animation="none"}))}}catch{}

  // 1) First paint from cache
  const t=g(); t && w(t);

  // 2) Register SW
  await S();

  // 3) Fast network fetch (700ms cap)
  const n=await m(); n && (y(n), w(n));
}

window.addEventListener("DOMContentLoaded",k);
})();
