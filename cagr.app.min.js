(()=>{"use strict";const e="1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg",t="Headlines",n="",o=(e,t,n)=>`https://docs.google.com/spreadsheets/d/${e}/gviz/tq?tqx=out:csv&headers=1&sheet=${encodeURIComponent(t)}&range=${encodeURIComponent(n)}&t=${Date.now()}`,r=(e,t)=>`https://docs.google.com/spreadsheets/d/${e}/export?format=csv&id=${e}&gid=${encodeURIComponent(t)}&t=${Date.now()}`;function a(e){if((e||"").trim().startsWith("<"))return{rows:[],isHtml:!0};const t=[];let n=[],o="",r=!1;for(let a=0;a<e.length;a++){const i=e[a];if(r)'"'!==i?o+=i:'"'===e[a+1]?(o+='"',a++):r=!1;else if('"'!==i)if(","===i)n.push(o),o="";else if("\n"===i)n.push(o),t.push(n),n=[],o="";else"\r"!==i&&(o+=i);else r=!0}return(o.length>0||n.length>0)&&(n.push(o),t.push(n)),{rows:t,isHtml:!1}}async function i({sheetId:e,sheet:t,range:n,gid:i,label:s}){const l=[{url:o(e,t,n),kind:"gviz"}];i&&String(i).trim()&&l.push({url:r(e,i),kind:"export"});let c=null;for(const e of l)try{const t=await fetch(e.url,{cache:"no-store"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const n=await t.text(),{rows:o,isHtml:r}=a(n);if(r)throw new Error("Returned HTML (tab likely not public)");if(!o.length)throw new Error("Empty CSV");const i=o[0].map((e=>e.replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim()));return{data:o.slice(1).filter((e=>e.some((e=>(e??"").toString().trim()!=="")))).map((e=>Object.fromEntries(i.map(((t,n)=>[t,(e[n]??"").toString().trim()]))))),route:e.kind}}catch(e){c=e}throw new Error(`${s} fetch failed: ${c?.message||"Unknown"}`)}function s(e,t,n="right"){const o=document.getElementById(e);if(!o)return;o.classList.remove("ticker-left","ticker-right"),o.textContent="";[...t,...t].forEach((e=>{const t=document.createElement("span");t.textContent=String(e||"").trim(),o.appendChild(t)}));void o.offsetWidth,o.classList.add("right"===n?"ticker-right":"ticker-left","ticker");const r=o.parentElement?.clientWidth||0;for(;o.scrollWidth<2*r;){const e=o.cloneNode(!0);[...e.children].forEach((e=>o.appendChild(e)))}}async function l(){try{const{data:o}=await i({sheetId:e,sheet:t,range:"A:B",gid:n,label:"Headlines"}),r=o.filter((e=>/^top$/i.test((e.Section||"").toString()))).map((e=>e.Text)).filter(Boolean),a=o.filter((e=>/^bottom$/i.test((e.Section||"").toString()))).map((e=>e.Text)).filter(Boolean);r.length&&s("topTicker",r,"right"),a.length&&s("bottomTicker",a,"left")}catch(e){console.warn("Headlines load error:",e)}}const c=e=>document.querySelector(e),d=(e,t)=>{const n=document.getElementById(e);if(!n)return;const o=String(null!=t?t:"—");n.textContent=o,n.title=o},u=e=>Number.isFinite(e)?(e>=0?"+":"")+(100*e).toFixed(2)+"%":"—",m=(e,t=2)=>Number.isFinite(e)?e.toLocaleString("en-IN",{maximumFractionDigits:t}):"—";document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("year");e&&(e.textContent=(new Date).getFullYear())})),(()=>{const e=document.getElementById("copyLink");e&&e.addEventListener("click",(async()=>{try{await navigator.clipboard.writeText(location.href);const t=e.textContent;e.textContent="Copied!",setTimeout((()=>e.textContent=t),1200)}catch{}}))})();const p=c("#timeMode"),g=c("#yearsWrap"),h=c("#dateWrap");function f(){const e=p.value;g.classList.toggle("hidden","years"!==e),h.classList.toggle("hidden","dates"!==e)}p.addEventListener("change",f);function v(e,t){const n=new Date(e),o=new Date(t);return isNaN(n)||isNaN(o)?NaN:(o-n)/(365.25*24*3600*1e3)}function y(){const e=Number(c("#cagrStart").value),t=Number(c("#cagrEnd").value),n="years"===p.value?Number(c("#cagrYears").value):v(c("#dateStart").value,c("#dateEnd").value),o=c("#cagrMsg");if(o.textContent="",!(e>0)||!(t>0))return o.textContent="Enter positive start and end values.",o.className="hint err",void 0;if(!(n>0))return o.textContent="Time must be > 0 years (use dates or decimals).",o.className="hint err",void 0;const r=Math.pow(t/e,1/n)-1,a=t/e-1;d("cagrOut",u(r)),d("totalReturnOut",u(a)),d("yearsOut",m(n,4)),o.textContent="Done.",o.className="hint",S()}c("#calcCAGR").addEventListener("click",y),c("#resetCAGR").addEventListener("click",(()=>{["#cagrStart","#cagrEnd","#cagrYears","#dateStart","#dateEnd"].forEach((e=>c(e).value="")),d("cagrOut","—"),d("totalReturnOut","—"),d("yearsOut","—"),c("#cagrMsg").textContent="",S()}));function b(e,t){let n=0;for(let o=0;o<t.length;o++)n+=t[o]/Math.pow(1+e,o);return n}function E(e){const t=e.some((e=>e>0)),n=e.some((e=>e<0));if(!t||!n)return{ok:!1,reason:"Cashflows must include at least one inflow and one outflow."};let o=-.9999,r=10,a=b(o,e),i=b(r,e);if(a*i>0){for(let t=10;t<=1e3&&a*i>0;t*=2)r=t,i=b(r,e);if(a*i>0)return{ok:!1,reason:"Could not bracket IRR (NPV did not change sign)."}}for(let t=0;t<200;t++){const t=(o+r)/2,n=b(t,e);if(Math.abs(n)<1e-7)return{ok:!0,rate:t};a*n<=0?(r=t,i=n):(o=t,a=n);if(Math.abs(r-o)<1e-9)return{ok:!0,rate:(o+r)/2}}return{ok:!0,rate:(o+r)/2}}function x(){if("guided"===c("#mode").value){const e=Number(c("#initOutflow").value||0),t=Number(c("#contribution").value||0),n=Number(c("#periods").value||0),o=Number(c("#finalValue").value||0),r=[e];for(let e=1;e<=n;e++)r.push(t);return r.push(o),r}const e=c("#series").value.trim();return e.split(",").map((e=>Number(e.trim()))).filter((e=>Number.isFinite(e)))}function k(){const e=c("#irrMsg");e.textContent="";const t=x();if(!t.length)return e.textContent="Add some cashflows first.",e.className="hint err",void(d("irrPerPeriod","—"),d("irrAnnual","—"),d("npvAtIrr","—"));const n=E(t);if(!n.ok)return e.textContent=n.reason||"IRR failed to converge.",e.className="hint err",void(d("irrPerPeriod","—"),d("irrAnnual","—"),d("npvAtIrr","—"));const o=n.rate,r=Number(c("#freq").value||12),a=Math.pow(1+o,r)-1;d("irrPerPeriod",u(o)),d("irrAnnual",u(a)),d("npvAtIrr",m(b(o,t),4)),e.textContent="Done.",e.className="hint",S()}c("#calcIRR").addEventListener("click",k),c("#resetIRR").addEventListener("click",(()=>{["#initOutflow","#contribution","#periods","#finalValue","#series"].forEach((e=>c(e).value="")),d("irrPerPeriod","—"),d("irrAnnual","—"),d("npvAtIrr","—"),c("#irrMsg").textContent="",S()}));const w=c("#mode");function C(){const e=w.value;c("#guidedWrap").classList.toggle("hidden","guided"!==e),c("#seriesWrap").classList.toggle("hidden","series"!==e)}w.addEventListener("change",C);function S(){const e=new URLSearchParams,t=c("#timeMode").value;c("#cagrStart").value&&e.set("cs",c("#cagrStart").value),c("#cagrEnd").value&&e.set("ce",c("#cagrEnd").value),e.set("tm",t),"years"===t&&c("#cagrYears").value&&e.set("cy",c("#cagrYears").value),"dates"===t&&(c("#dateStart").value&&e.set("ds",c("#dateStart").value),c("#dateEnd").value&&e.set("de",c("#dateEnd").value)),e.set("f",c("#freq").value),e.set("m",c("#mode").value),"guided"===c("#mode").value?(c("#initOutflow").value&&e.set("i",c("#initOutflow").value),c("#contribution").value&&e.set("c",c("#contribution").value),c("#periods").value&&e.set("n",c("#periods").value),c("#finalValue").value&&e.set("fv",c("#finalValue").value)):c("#series").value.trim()&&e.set("s",c("#series").value.trim()),history.replaceState(null,"","?"+e.toString())}function I(){const e=new URLSearchParams(location.search),t=(t,n=null)=>e.has(t)?e.get(t):n;c("#cagrStart").value=t("cs",""),c("#cagrEnd").value=t("ce","");const n=t("tm","years");c("#timeMode").value=n,"years"===n?c("#cagrYears").value=t("cy",""):(c("#dateStart").value=t("ds",""),c("#dateEnd").value=t("de","")),f(),c("#freq").value=t("f","12"),c("#mode").value=t("m","guided"),C(),"guided"===c("#mode").value?(c("#initOutflow").value=t("i",""),c("#contribution").value=t("c",""),c("#periods").value=t("n",""),c("#finalValue").value=t("fv","")):c("#series").value=t("s","")}function P(e){return"e1"===e?(c("#timeMode").value="years",f(),c("#cagrStart").value="100000",c("#cagrEnd").value="145000",c("#cagrYears").value="3",y()):"e2"===e?(c("#timeMode").value="dates",f(),c("#cagrStart").value="500000",c("#cagrEnd").value="800000",c("#dateStart").value="2020-04-01",c("#dateEnd").value="2025-10-01",y()):"e3"===e?(c("#timeMode").value="years",f(),c("#cagrStart").value="200000",c("#cagrEnd").value="180000",c("#cagrYears").value="2",y()):void 0}function L(e){return"g1"===e?(c("#mode").value="guided",C(),c("#freq").value="12",c("#initOutflow").value="-100000",c("#contribution").value="5000",c("#periods").value="12",c("#finalValue").value="145000",k()):"g2"===e?(c("#mode").value="guided",C(),c("#freq").value="12",c("#initOutflow").value="-500000",c("#contribution").value="0",c("#periods").value="0",c("#finalValue").value="650000",k()):"s1"===e?(c("#mode").value="series",C(),c("#freq").value="12",c("#series").value="-100000, 10000, 10000, 10000, 145000",k()):void 0}document.addEventListener("click",(e=>{const t=e.target.closest("[data-ex-cagr]");if(t)return void P(t.getAttribute("data-ex-cagr"));const n=e.target.closest("[data-ex-irr]");n&&L(n.getAttribute("data-ex-irr"))})),(()=>{I(),f(),C(),l().catch(console.error),setInterval((()=>l().catch(console.error)),3e5)})(),window.addEventListener("keydown",(e=>{const t=navigator.platform.toUpperCase().includes("MAC");(t&&e.metaKey&&"k"===e.key.toLowerCase()||!t&&e.ctrlKey&&"k"===e.key.toLowerCase())&&(e.preventDefault(),document.getElementById("cagrStart")?.focus())}))})();
