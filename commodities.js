(()=>{"use strict";const H="1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg",S="1teXTyGTeArJisKZquhirLIbwLMcur1JbVLdUZHxWbsM",T="Commodities54",O=[{key:"BRN",name:"Brent Crude Oil",ticker:"BRN",cat:"energy"},{key:"CL",name:"WTI Crude Oil",ticker:"CL",cat:"energy"},{key:"NG",name:"Natural Gas (Henry Hub)",ticker:"NG",cat:"energy"},{key:"RB-GAS",name:"RBOB Gasoline",ticker:"RB",cat:"energy"},{key:"HO",name:"ULSD Heating Oil",ticker:"HO",cat:"energy"},{key:"G",name:"Gasoil (Low Sulphur)",ticker:"G",cat:"energy"},{key:"NBP",name:"UK Nat Gas (NBP)",ticker:"NBP",cat:"energy"},{key:"TTF",name:"Dutch TTF Gas",ticker:"TTF",cat:"energy"},{key:"NCF",name:"Coal (Newcastle)",ticker:"NCF",cat:"energy"},{key:"API2",name:"Coal (API2 Rotterdam)",ticker:"API2",cat:"energy"},{key:"PRO",name:"Propane (Mont Belvieu)",ticker:"PRO",cat:"energy"},{key:"NAP",name:"Naphtha (Japan CFR)",ticker:"NAP",cat:"energy"},{key:"GC",name:"Gold",ticker:"GC",cat:"metals"},{key:"SI",name:"Silver",ticker:"SI",cat:"metals"},{key:"PL",name:"Platinum",ticker:"PL",cat:"metals"},{key:"PA",name:"Palladium",ticker:"PA",cat:"metals"},{key:"HG",name:"Copper",ticker:"HG",cat:"metals"},{key:"AH",name:"Aluminum (Primary)",ticker:"AH",cat:"metals"},{key:"ZN",name:"Zinc",ticker:"ZN",cat:"metals"},{key:"LD",name:"Lead",ticker:"LD",cat:"metals"},{key:"NI",name:"Nickel",ticker:"NI",cat:"metals"},{key:"SN",name:"Tin",ticker:"SN",cat:"metals"},{key:"HRC",name:"Steel HRC (US Midwest)",ticker:"HRC",cat:"metals"},{key:"IOR",name:"Iron Ore 62% CFR China",ticker:"IOR",cat:"metals"},{key:"L3",name:"Lithium Hydroxide CIF CJK",ticker:"L3",cat:"metals"},{key:"CO",name:"Cobalt (MB)",ticker:"CO",cat:"metals"},{key:"RB-REBAR",name:"Steel Rebar (Shanghai)",ticker:"RB",cat:"metals"},{key:"MO",name:"Molybdenum",ticker:"MO",cat:"metals"},{key:"ZC",name:"Corn",ticker:"ZC",cat:"agri"},{key:"ZS",name:"Soybeans",ticker:"ZS",cat:"agri"},{key:"ZM",name:"Soybean Meal",ticker:"ZM",cat:"agri"},{key:"ZL",name:"Soybean Oil",ticker:"ZL",cat:"agri"},{key:"ZW",name:"Wheat (Chicago SRW)",ticker:"ZW",cat:"agri"},{key:"KE",name:"Wheat (KC HRW)",ticker:"KE",cat:"agri"},{key:"MWE",name:"Wheat (Minneapolis HRS)",ticker:"MWE",cat:"agri"},{key:"ZO",name:"Oats",ticker:"ZO",cat:"agri"},{key:"ZR",name:"Rough Rice",ticker:"ZR",cat:"agri"},{key:"RS",name:"Canola",ticker:"RS",cat:"agri"},{key:"RAP",name:"Rapeseed",ticker:"RAP",cat:"agri"},{key:"BSW",name:"Black Sea Wheat",ticker:"BSW",cat:"agri"},{key:"FCPO",name:"Palm Oil (FCPO)",ticker:"FCPO",cat:"softs"},{key:"SUNOIL",name:"Sunflower Oil (indicative)",ticker:"SUNOIL",cat:"softs"},{key:"SB",name:"Sugar No.11 (Raw)",ticker:"SB",cat:"softs"},{key:"W",name:"Sugar No.5 (White)",ticker:"W",cat:"softs"},{key:"KC",name:"Coffee (Arabica)",ticker:"KC",cat:"softs"},{key:"RM",name:"Coffee (Robusta)",ticker:"RM",cat:"softs"},{key:"CC",name:"Cocoa (NY)",ticker:"CC",cat:"softs"},{key:"LCC",name:"Cocoa (London)",ticker:"LCC",cat:"softs"},{key:"CT",name:"Cotton No.2",ticker:"CT",cat:"softs"},{key:"OJ",name:"Orange Juice",ticker:"OJ",cat:"softs"},{key:"LE",name:"Live Cattle",ticker:"LE",cat:"livestock"},{key:"GF",name:"Feeder Cattle",ticker:"GF",cat:"livestock"},{key:"HE",name:"Lean Hogs",ticker:"HE",cat:"livestock"},{key:"DC",name:"Class III Milk",ticker:"DC",cat:"dairy"}];
const U=(i,s,r)=>`https://docs.google.com/spreadsheets/d/${i}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(s)}&range=${encodeURIComponent(r)}&t=${Date.now()}`,P=t=>{if((t||"").trim().startsWith("<"))return{rows:[],isHtml:!0};const e=[];let n=[],a="",o=!1;for(let l=0;l<t.length;l++){const c=t[l];if(o)c==='"'?(t[l+1]==='"'?(a+='"',l++):o=!1):a+=c;else if(c==='"')o=!0;else if(c===",")n.push(a),a="";else if(c==="\n")n.push(a),e.push(n),n=[],a="";else c!=="\r"&&(a+=c)}return(a.length>0||n.length>0)&&(n.push(a),e.push(n)),{rows:e,isHtml:!1}},A=async(i,s,r)=>{const t=await fetch(U(i,s,r));if(!t.ok)throw new Error(`Sheet fetch failed: ${i}/${s} (${t.status})`);const e=await t.text(),{rows:n,isHtml:a}=P(e);if(a){const o=new Error("Sheet returned HTML (likely not public/published)");throw o.code="HTML",o}if(!n.length)return[];const o=n[0].map(l=>l.replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim());return n.slice(1).filter(l=>l.some(c=>(c??"").toString().trim()!=="")).map(l=>Object.fromEntries(o.map((c,d)=>[c,(l[d]??"").toString().trim()])))},R=(i,s)=>{for(const r of s){const t=i[r];if(t!=null&&String(t).trim()!=="")return t}const r=(s[0]||"").toLowerCase();for(const t of Object.keys(i))if(t.toLowerCase().includes(r)&&String(i[t]).trim()!=="")return i[t]},N=i=>String(i??"").replace(/[₹,$]/g,"").replace(/\u00A0/g," ").replace(/[()%]/g,"").replace(/[−–—]/g,"-").replace(/,/g,"").trim(),I=i=>{const s=N(i);if(!s)return NaN;const r=Number(s);return Number.isFinite(r)?r:NaN},w=(i,s,r)=>Math.min(r,Math.max(s,i)),M=(i,s,r)=>i+(s-i)*r,B=i=>{if(!Number.isFinite(i))return{bg:"#e5e7eb",fg:"#111"};const s=w(i,-5,5),r=(s+5)/10,t=(a,o,l,c)=>c<=.5?[(0|Math.round(M(a[0],o[0],c/.5))),(0|Math.round(M(a[1],o[1],c/.5))),(0|Math.round(M(a[2],o[2],c/.5)))]:[(0|Math.round(M(o[0],l[0],(c-.5)/.5))),(0|Math.round(M(o[1],l[1],(c-.5)/.5))),(0|Math.round(M(o[2],l[2],(c-.5)/.5)))],e=[220,38,38],n=[245,158,11],a=[22,163,74],[o,l,c]=t(e,n,a,r),d=(.2126*o+.7152*l+.0722*c)/255,u=d<.55?"#fff":"#111",g=h=>h.toString(16).padStart(2,"0");return{bg:`#${g(o)}${g(l)}${g(c)}`,fg:u}},K=(i,s)=>{const r=String(i||"").toUpperCase();if(r==="RB"){if(/rebar/i.test(s))return"RB-REBAR";if(/gasoline|rbob/i.test(s))return"RB-GAS"}const t=O.find(e=>e.ticker===r);return t?t.key:r||s},D=i=>{const s=R(i,["Name","Commodity","Label"])||"",r=(R(i,["Ticker","Symbol"])||"").toUpperCase().trim(),t=R(i,["Exchange"])||"",e=(R(i,["Category","Group","Type"])||"").toLowerCase(),n=(R(i,["Quote CCY","CCY","Currency"])||"").toUpperCase(),a=I(R(i,["Last_Price (Native)","Price","Last","Value","Close"])),o=I(R(i,["1D Change %","% Change","%Chg","ChangePct","Pct"])),l=R(i,["Last_Price (INR)"]),c=K(r,s),d=O.find(u=>u.key===c)||{},g=e||d.cat||"",h=Number.isFinite(a)?n?`${n} ${a.toLocaleString("en-IN",{maximumFractionDigits:2,minimumFractionDigits:2})}`:a.toLocaleString("en-IN",{maximumFractionDigits:2,minimumFractionDigits:2}):R(i,["Last_Price (Native)"])||"—",m=l&&String(l).trim()?String(l):"—";return{key:c,name:s||(d.name||r),sym:r,exch:t,category:g,ccy:n,lastNative:a,lastNativeTxt:h,chgp:o,lastInrTxt:m}},E=i=>{const s=new Map;return i.forEach(r=>{const t=D(r);t&&t.key&&s.set(t.key,t)}),s},F=(i,s)=>{const r=Number.isFinite(i.chgp)?((i.chgp>=0?"+":"")+i.chgp.toFixed(2)+"%"):"—";return`
  <div class="tile" style="background:${s.bg}; color:${s.fg}"
    data-sym="${i.sym}"
    data-name="${(i.name||i.sym).replace(/"/g,"&quot;")}"
    data-pct="${r}"
    data-last="${i.lastNativeTxt}"
    data-exch="${i.exch||""}"
    data-cat="${i.category||""}"
    data-inr="${i.lastInrTxt||"—"}"
    aria-label="${i.sym}: ${r}">
    <div class="inner">
      <div class="top">
        <div class="min-w-0">
          <div class="name truncate" title="${i.name||i.sym}">${i.sym||i.key}</div>
          <div class="meta"><span>${i.lastNativeTxt}</span></div>
        </div>
        <span class="pill">${r}</span>
      </div>
      <div style="height:38px"></div>
    </div>
  </div>`},J={el:null,hideTo:null,init(){this.el=document.getElementById("hoverCard")},fill(i){document.getElementById("hcTitle").textContent=i.dataset.name||i.dataset.sym||"",document.getElementById("hcSym").textContent=i.dataset.sym||"—",document.getElementById("hcPct").textContent=i.dataset.pct||"—",document.getElementById("hcLast").textContent=i.dataset.last||"—",document.getElementById("hcExch").textContent=i.dataset.exch||"—",document.getElementById("hcCat").textContent=i.dataset.cat||"—",document.getElementById("hcINR").textContent=i.dataset.inr||"—"},position(i){const s=i.getBoundingClientRect(),r=innerWidth,t=innerHeight,e=this.el,n=Math.min(380,r-24);let a=s.left+Math.min(16,Math.max(8,s.width*.1)),o=s.top>t/2?s.top-12:s.bottom+12;a+n+12>r&&(a=r-n-12),a<12&&(a=12),e.style.visibility="hidden",e.style.display="block",e.style.width=n+"px";const l=e.offsetHeight||200;e.style.display="",e.style.visibility="",s.top>t/2&&o-l<8&&(o=s.bottom+12),s.top<=t/2&&o+l>t-8&&(o=s.top-12),o<8&&(o=8),o+l>t-8&&(o=t-l-8),e.style.left=`${a}px`,e.style.top=`${o}px`},show(i){this.hideTo&&(clearTimeout(this.hideTo),this.hideTo=null),this.fill(i),this.position(i),this.el.setAttribute("data-show","true"),this.el.setAttribute("aria-hidden","false")},hide(){this.hideTo&&clearTimeout(this.hideTo),this.hideTo=setTimeout(()=>{this.el.removeAttribute("data-show"),this.el.setAttribute("aria-hidden","true")},80)}},z=(i,s,r="right")=>{const t=document.getElementById(i);if(!t)return;t.className=`ticker ${r==="right"?"ticker-right":"ticker-left"} text-sm font-medium`,t.innerHTML="";[...s,...s].forEach(e=>{const n=document.createElement("span");n.textContent=e,t.appendChild(n)})},Q=i=>{const s=document.getElementById("diag"),r=document.getElementById("diagText");r.textContent=i,s.classList.remove("hidden")},V=async()=>{try{const i=await A(H,"Headlines","A:B"),s=i.filter(r=>/^top$/i.test((r.Section||"").toString())).map(r=>r.Text),r=i.filter(t=>/^bottom$/i.test((t.Section||"").toString())).map(t=>t.Text);z("topTicker",s,"right"),z("bottomTicker",r,"left")}catch(i){console.warn("Headlines error",i)}},G=async()=>{try{const i=await A(S,T,"A:Z");if(!i.length)throw new Error("No rows from sheet");return i}catch(i){return console.warn("Commodities load failed:",i),Q('Live Commodities sheet not accessible — ensure it is public & “Publish to web”. Showing demo order with neutral values.'),O.map(s=>({Name:s.name,Ticker:s.ticker,Exchange:"",Category:s.cat,"Quote CCY":"","Last_Price (Native)":"","1D Change %":"","Last_Price (INR)":""}))}},Y=i=>{const s=document.getElementById("tiles"),r=document.getElementById("emptyState");s.innerHTML="";const t=E(i),e=O.map(o=>{const l=t.get(o.key);return l?l:D({Name:o.name,Ticker:o.ticker,Exchange:"",Category:o.cat,"Quote CCY":"","Last_Price (Native)":"","1D Change %":"","Last_Price (INR)":""})}),n=e.map(o=>o.chgp).filter(Number.isFinite),a=n.length?Math.min(...n):0,o=n.length?Math.max(...n):0;document.getElementById("rangeInfo").textContent=`Range: ${a.toFixed(2)}% … ${o.toFixed(2)}%`,document.getElementById("countInfo").textContent=`${e.length} commodities`,e.length?r.classList.add("hidden"):r.classList.remove("hidden");const l=document.createDocumentFragment();e.forEach(c=>{const d=B(c.chgp),u=document.createElement("div");u.innerHTML=F(c,d);const g=u.firstElementChild;g.addEventListener("mouseenter",()=>J.show(g)),g.addEventListener("mousemove",()=>J.position(g)),g.addEventListener("mouseleave",()=>J.hide()),l.appendChild(g)}),s.appendChild(l)},Z=async()=>{const i=document.getElementById("year");i&&(i.textContent=(new Date).getFullYear().toString()),J.init(),await V();const s=await G();Y(s);const r=new Date;document.getElementById("lastUpdated").textContent=`Updated ${r.toLocaleString("en-IN")} · Source: Commodities54`};Z().catch(i=>{console.error(i),Q("Unexpected error rendering — check sheet access or headers.")})})();
