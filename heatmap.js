(()=>{"use strict";const e=["RELIANCE","TCS","HDFCBANK","ICICIBANK","SBIN","INFY","ITC","LT","BHARTIARTL","HINDUNILVR","AXISBANK","KOTAKBANK","BAJFINANCE","BAJAJFINSV","MARUTI","TATAMOTORS","M&M","TITAN","ULTRACEMCO","GRASIM","HCLTECH","WIPRO","LTIM","TECHM","SUNPHARMA","CIPLA","DRREDDY","APOLLOHOSP","HDFCLIFE","SBILIFE","ONGC","COALINDIA","NTPC","POWERGRID","ADANIENT","ADANIPORTS","JSWSTEEL","TATASTEEL","HINDALCO","INDUSINDBK","BANKBARODA","PNB","IDFCFIRSTB","DLF","NESTLEIND","BRITANNIA","DMART","ASIANPAINT","EICHERMOT","HEROMOTOCO","BAJAJ-AUTO","ZOMATO","POLICYBZR","IRCTC"],t="1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg",n="1U1oKx9ANorRUtHGHsavSjxR06cqTThE09yuy4q_i_28",a="Active54",r="292671583",o=(e,t,n)=>`https://docs.google.com/spreadsheets/d/${e}/gviz/tq?tqx=out:csv&headers=1&sheet=${encodeURIComponent(t)}&range=${encodeURIComponent(n)}&t=${Date.now()}`,i=(e,t)=>`https://docs.google.com/spreadsheets/d/${e}/export?format=csv&id=${e}&gid=${encodeURIComponent(t)}&t=${Date.now()}`,s=e=>{if((e??"").trim().startsWith("<"))return{rows:[],isHtml:!0};const t=[];let n=[],a="",r=!1;for(let o=0;o<e.length;o++){const i=e[o];if(r)34!==i.charCodeAt(0)?a+=i:e[o+1]==='"'?(a+='"',o++):r=!1;else if('"'===i)r=!0;else if(","===i)n.push(a),a="";else if("\n"===i)n.push(a),t.push(n),n=[],a="";else"\r"!==i&&(a+=i)}return(a.length>0||n.length>0)&&(n.push(a),t.push(n)),{rows:t,isHtml:!1}},l=async({sheetId:e,sheet:t,range:n,gid:a,label:r})=>{const l=[{url:o(e,t,n),kind:"gviz"}];a&&String(a).trim()&&l.push({url:i(e,a),kind:"export"});let c=null;for(const d of l)try{const e=await fetch(d.url,{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.text(),{rows:n,isHtml:a}=s(t);if(a)throw new Error("Returned HTML (not published / access-limited)");if(!n.length)throw new Error("Empty CSV");const r=n[0].map((e=>e.replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim()));return{data:n.slice(1).filter((e=>e.some((e=>(e??"").toString().trim()!=="")))).map((e=>Object.fromEntries(r.map(((t,n)=>[t,(e[n]??"").toString().trim()]))))),route:d.kind}}catch(e){c=e}throw new Error(`${r} fetch failed: ${c?.message||"Unknown"}`)},c=(e,t)=>{for(const n of t){const t=e[n];if(null!=t&&String(t).trim()!=="")return t}const n=(t[0]||"").toLowerCase();for(const t of Object.keys(e))if(t.toLowerCase().includes(n)&&String(e[t]).trim()!=="")return e[t]},d=e=>{if(null==e)return"";return String(e).replace(/[₹,]/g,"").replace(/\u00A0/g," ").replace(/[()%]/g,"").replace(/[−–—]/g,"-").trim()},u=e=>{const t=d(e);if(!t)return NaN;const n=Number(t);return Number.isFinite(n)?n:NaN},p=(e,t,n)=>Math.min(n,Math.max(t,e)),m=(e,t,n)=>e+(t-e)*n,h=e=>{if(!Number.isFinite(e))return{bg:"#e5e7eb",fg:"#111"};const t=p(e,-5,5),n=(t+5)/10;function a(e){return e.toString(16).padStart(2,"0")}function r(e,t,n,a){if(a<=.5){const r=a/.5;return[Math.round(m(e[0],t[0],r)),Math.round(m(e[1],t[1],r)),Math.round(m(e[2],t[2],r))]}{const r=(a-.5)/.5;return[Math.round(m(t[0],n[0],r)),Math.round(m(t[1],n[1],r)),Math.round(m(t[2],n[2],r))]}}const o=[220,38,38],i=[245,158,11],s=[22,163,74],[l,c,d]=r(o,i,s,n),u=(.2126*l+.7152*c+.0722*d)/255;return{bg:`#${a(l)}${a(c)}${a(d)}`,fg:u<.55?"#fff":"#111"}},g=e=>{const t=e.map(u).filter(Number.isFinite);if(!t.length)return"";if(1===t.length){const e=15;return`M0,${e} L100,${e}`}const n=100,a=30,r=2,o=Math.min(...t),i=Math.max(...t),s=i-o||1;return t.map(((t,l)=>{const c=l/(e.length-1)*n,d=a-r-(t-o)/s*(a-2*r);return(l?"L":"M")+c.toFixed(2)+","+d.toFixed(2)})).join(" ")},y=e=>{const t=(c(e,["Symbol","Ticker","Code"])||"").toUpperCase().trim(),n=c(e,["Name","Company","Label"])||t||"—",a=u(c(e,["Price","Last","LTP","Close","Close Price","Value"])),r=u(c(e,["Change","Chg","Net Chg","Net Change"])),o=u(c(e,["% Change","%Change","%Chg","Change %","Chg %","ChangePct","Pct"])),i=c(e,["High","Day High","H"])||"",s=c(e,["Low","Day Low","L"])||"",l=c(e,["Volume","Vol"])||"",d=c(e,["Mkt Cap","Market Cap","Mcap","MarketCapitalization"])||"";let p=c(e,["7D Spark","Spark","Sparkline"]);if(!p){const t=Object.keys(e).filter((e=>/^s\d+$/i.test(e)));t.length&&(p=t.sort(((e,t)=>Number(e.slice(1))-Number(t.slice(1)))).map((t=>e[t])).join(","))}const m=(p||"").split(",").map((e=>e.trim())).filter(Boolean);return{sym:t,name:n,last:a,chg:r,chgp:o,high:i,low:s,vol:l,mcap:d,sparkVals:m}},f=e=>{const t=new Map;return e.forEach((e=>{const n=y(e);n.sym&&t.set(n.sym,n)})),t},v=(e,t,n)=>{const a=Number.isFinite(e.chgp)?(e.chgp>=0?"+":"")+e.chgp.toFixed(2)+"%":"—",r=Number.isFinite(e.last)?e.last.toLocaleString("en-IN",{maximumFractionDigits:2,minimumFractionDigits:2}):"—",o=Number.isFinite(e.chg)?(e.chg>=0?"+":"")+e.chg.toLocaleString("en-IN",{maximumFractionDigits:2,minimumFractionDigits:2}):"",i=Number.isFinite(e.chgp)&&e.chgp>=0?"#16a34a":"#dc2626",s=e.sparkVals&&e.sparkVals.length>=1,l=e=>String(e).replace(/"/g,"&quot;");return`<div class="tile" style="background:${t.bg}; color:${t.fg}" data-sym="${l(e.sym)}" data-name="${l(e.name)}" data-pct="${l(a)}" data-last="${l(r)}" data-chg="${l(o)}" data-high="${l(e.high)}" data-low="${l(e.low)}" data-vol="${l(e.vol)}" data-mcap="${l(e.mcap)}"><div class="inner"><div class="top"><div class="min-w-0"><div class="name truncate" title="${l(e.name)}">${l(e.sym)}</div><div class="meta"><span>${r}</span></div></div><span class="pill">${a}</span></div>${s?`<svg class="spark" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true"><path id="spark-${n}" d="" stroke="${i}"></path></svg>`:'<div style="height:38px"></div>'}</div></div>`},b=(e,t)=>{const n=g(e.sparkVals);if(!n)return;const a=document.getElementById(`spark-${t}`);a&&a.setAttribute("d",n)},S={el:null,hideTo:null,init(){this.el=document.getElementById("hoverCard")},fill(e){document.getElementById("hcTitle").textContent=e.dataset.name||e.dataset.sym||"",document.getElementById("hcSym").textContent=e.dataset.sym||"—",document.getElementById("hcPct").textContent=e.dataset.pct||"—",document.getElementById("hcLast").textContent=e.dataset.last||"—",document.getElementById("hcChg").textContent=e.dataset.chg||"—",document.getElementById("hcHigh").textContent=e.dataset.high||"—",document.getElementById("hcLow").textContent=e.dataset.low||"—",document.getElementById("hcVol").textContent=e.dataset.vol||"—",document.getElementById("hcMcap").textContent=e.dataset.mcap||"—"},position(e){const t=e.getBoundingClientRect(),n=innerWidth,a=innerHeight,r=this.el,o=Math.min(380,n-24);let i=t.left+Math.min(16,Math.max(8,.1*t.width)),s=t.top>a/2?t.top-12:t.bottom+12;r.style.visibility="hidden",r.style.display="block",r.style.width=o+"px";const l=r.offsetHeight||200;r.style.display="",r.style.visibility="",t.top>a/2&&s-l<8&&(s=t.bottom+12),t.top<=a/2&&s+l>a-8&&(s=t.top-12),i+o+12>n&&(i=n-o-12),i<12&&(i=12),s<8&&(s=8),s+l>a-8&&(s=a-l-8),r.style.left=`${i}px`,r.style.top=`${s}px`},show(e){this.hideTo&&(clearTimeout(this.hideTo),this.hideTo=null),this.fill(e),this.position(e),this.el.setAttribute("data-show","true"),this.el.setAttribute("aria-hidden","false")},hide(){this.hideTo&&clearTimeout(this.hideTo),this.hideTo=setTimeout((()=>{this.el.removeAttribute("data-show"),this.el.setAttribute("aria-hidden","true")}),80)}};function C(e,t,n="right"){const a=document.getElementById(e);if(!a)return;a.className=`ticker ${"right"===n?"ticker-right":"ticker-left"} text-sm font-medium`,a.innerHTML="";[...t,...t].forEach((e=>{const t=document.createElement("span");t.textContent=e,a.appendChild(t)}))}const E=e=>{const t=document.getElementById("diag"),n=document.getElementById("diagText");n.textContent=e,t.classList.remove("hidden")},L=async()=>{try{const{data:e}=await l({sheetId:t,sheet:"Headlines",range:"A:B",gid:"",label:"Headlines"}),n=e.filter((e=>/^top$/i.test((e.Section||"").toString()))).map((e=>e.Text)).filter(Boolean),a=e.filter((e=>/^bottom$/i.test((e.Section||"").toString()))).map((e=>e.Text)).filter(Boolean);C("topTicker",n,"right"),C("bottomTicker",a,"left")}catch(e){console.warn("Headlines error",e)}},q=async()=>{try{const{data:e,route:t}=await l({sheetId:n,sheet:a,range:"A:J",gid:r,label:"Active54"});return console.log(`[Active54] via ${t}; rows: ${e.length}`),e}catch(e){return console.warn("Active54 load failed:",e),E(`Active54 data not accessible — using fallback.
Checked sheetId=${n}, tab="${a}", gid=${r}.`),[]}},x=()=>e.map((e=>({Name:e,Symbol:e,Price:"0","Chg %":"0","% Change":"0",High:"",Low:"",Volume:"","Mkt Cap":"","7D Spark":"1,1.1,1.08,1.12,1.05,1.07,1.1"}))),w=t=>{const n=document.getElementById("heatmap"),a=document.getElementById("emptyState");n.innerHTML="";let r=f(t);0===r.size&&(r=f(x()));const o=e.map((e=>r.get(e)||y({Symbol:e,Price:"","% Change":""}))),i=o.map((e=>e.chgp)).filter(Number.isFinite),s=i.length?Math.min(...i):0,l=i.length?Math.max(...i):0;document.getElementById("rangeInfo").textContent=`Range: ${s.toFixed(2)}% … ${l.toFixed(2)}%`,document.getElementById("countInfo").textContent=`${o.length} tickers`,o.length?a.classList.add("hidden"):a.classList.remove("hidden");const c=document.createDocumentFragment();o.forEach(((e,t)=>{const a=h(e.chgp),r=document.createElement("div");r.innerHTML=v(e,a,t);const o=r.firstElementChild;o.addEventListener("mouseenter",(()=>S.show(o))),o.addEventListener("mousemove",(()=>S.position(o))),o.addEventListener("mouseleave",(()=>S.hide())),c.appendChild(o)})),n.appendChild(c),o.forEach(((e,t)=>b(e,t)))};async function k(){const e=document.getElementById("year");e&&(e.textContent=(new Date).getFullYear().toString()),S.init(),await L();const t=await q();w(t);const a=new Date;document.getElementById("lastUpdated").textContent=`Updated ${a.toLocaleString("en-IN")} · Source: ${t&&t.length?"Active54":"Fallback"}`}document.getElementById("reloadBtn")?.addEventListener("click",(()=>k())),setInterval((()=>k()),3e5),k().catch((e=>{console.error(e),E("Unexpected error rendering heatmap — loaded fallback.")}))})();
