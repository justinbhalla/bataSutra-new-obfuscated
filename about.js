// about.min.js
const SHEET_ID="1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg",HL_SHEET="Headlines",HL_RANGE="A:C",HL_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(HL_SHEET)}&range=${encodeURIComponent(HL_RANGE)}`;(function(){try{const e=document.createElement("link");e.rel="prefetch",e.href=HL_URL,e.as="fetch",e.crossOrigin="anonymous",document.head.appendChild(e)}catch{}})();function parseCsv(e){const t=[];let n=[],r="",o=!1;for(let a=0;a<e.length;a++){const c=e[a];if(o)'"'===c?'"'===e[a+1]?(r+='"',a++):o=!1:r+=c;else if('"'===c)o=!0;else if(","===c)n.push(r),r="";else if("\n"===c)n.push(r),t.push(n),n=[],r="";else"\r"!==c&&(r+=c)}return r.length>0||n.length>0?(n.push(r),t.push(n)):t}const HL_CACHE_KEY="bs_headlines_v2",HL_TTL_MS=9e5;function getHLCache(){try{const e=localStorage.getItem(HL_CACHE_KEY);if(!e)return null;const{ts:t,data:n}=JSON.parse(e);return Date.now()-t>HL_TTL_MS?null:n}catch{return null}}function setHLCache(e){try{localStorage.setItem(HL_CACHE_KEY,JSON.stringify({ts:Date.now(),data:e}))}catch{}}function fetchWithTimeout(e,t={},n=700){return new Promise((r,o)=>{const a=new AbortController,c=setTimeout(()=>{a.abort(),o(new Error("timeout"))},n);fetch(e,{...t,signal:a.signal,cache:"force-cache",credentials:"omit"}).then(e=>{clearTimeout(c),r(e)}).catch(e=>{clearTimeout(c),o(e)})})}async function fetchHeadlinesFast(){try{const e=await fetchWithTimeout(HL_URL);if(!e.ok)throw new Error("HTTP "+e.status);const t=await e.text();if(t.trim().startsWith("<"))return[];const n=parseCsv(t);if(!n.length)return[];const r=n[0].map(e=>e.replace(/^\uFEFF/,"").trim().toLowerCase()),o=r.indexOf("section"),a=r.indexOf("text");return o<0||a<0?[]:n.slice(1).map(e=>({section:(e[o]||"").toLowerCase().trim(),text:(e[a]||"").trim()})).filter(e=>e.text)}catch{return null}}function setAutoDuration(e,t){const n=(t||[]).join(" â€¢ ").length||120,r=Math.min(140,Math.max(60,Math.round(n/1.8)));e.style.setProperty("--dur",r+"s")}function renderTicker(e,t,n){if(!e||!t?.length)return;e.className=`ticker ${"right"===n?"ticker-right":"ticker-left"} ${"botTicker"===e.id?"text-sm text-slate-700":"text-sm font-medium"}`,e.innerHTML="";const r=t.concat(t);r.forEach(t=>{const n=document.createElement("span");n.textContent=t,e.appendChild(n)}),setAutoDuration(e,t)}function paintFromData(e){const t=document.getElementById("topTicker"),n=document.getElementById("botTicker");if(!e)return;const r=e.filter(e=>"top"===e.section).map(e=>e.text),o=e.filter(e=>"bottom"===e.section).map(e=>e.text);r.length&&renderTicker(t,r,"right"),o.length&&renderTicker(n,o,"left")}async function registerTickerSW(){if(!("serviceWorker"in navigator))return;const e=`\n    const CACHE = 'bs-tickers-v1';\n    const HL_URL = ${JSON.stringify(HL_URL)};\n    self.addEventListener('install', e => {\n      e.waitUntil(caches.open(CACHE).then(c => c.add(HL_URL)).catch(() => {}));\n      self.skipWaiting();\n    });\n    self.addEventListener('activate', e => { self.clients.claim(); });\n    self.addEventListener('fetch', e => {\n      const url = new URL(e.request.url);\n      if (url.href === HL_URL) {\n        e.respondWith((async () => {\n          const cache = await caches.open(CACHE);\n          const cached = await cache.match(HL_URL);\n          const netPromise = fetch(HL_URL, { cache: 'no-store' }).then(async r => {\n            if (r.ok) { await cache.put(HL_URL, r.clone()); postUpdate(); }\n            return r;\n          }).catch(() => null);\n          return cached || netPromise || fetch(HL_URL, { cache: 'force-cache' });\n        })());\n      }\n    });\n    async function postUpdate(){\n      const clientsArr = await self.clients.matchAll({ includeUncontrolled: true, type: 'window' });\n      for (const c of clientsArr) c.postMessage({ type: 'bs:hl-updated' });\n    }\n  `,t=new Blob([e],{type:"text/javascript"}),n=URL.createObjectURL(t);try{await navigator.serviceWorker.register(n,{scope:"./"})}catch{}}navigator.serviceWorker?.addEventListener?.("message",async e=>{if("bs:hl-updated"===e?.data?.type){const e=await fetch(HL_URL,{cache:"force-cache"});if(e.ok){const t=await e.text();if(!t.trim().startsWith("<")){const e=parseCsv(t);if(e.length){const t=e[0].map(e=>e.replace(/^\uFEFF/,"").trim().toLowerCase()),n=t.indexOf("section"),r=t.indexOf("text");if(n>=0&&r>=0){const t=e.slice(1).map(e=>({section:(e[n]||"").toLowerCase().trim(),text:(e[r]||"").trim()})).filter(e=>e.text);setHLCache(t),paintFromData(t)}}}}}});async function boot(){const e=document.getElementById("year");e&&(e.textContent=(new Date).getFullYear()),window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches&&document.querySelectorAll(".ticker-left, .ticker-right").forEach(e=>{e.style.animation="none"});const t=getHLCache();t&&paintFromData(t),await registerTickerSW();const n=await fetchHeadlinesFast();n&&(setHLCache(n),paintFromData(n))}window.addEventListener("DOMContentLoaded",boot);
