!function(){"use strict";
/* ===== CONFIG: Sheets → Headlines (A:C with Section,Text) ===== */
var SHEET_ID="1WN8151jGQjqbfO0Aj2tK-79yJ9gCD_z0DLCdxs_higg";
var HL_URL="https://docs.google.com/spreadsheets/d/"+SHEET_ID+"/gviz/tq?tqx=out:csv&sheet="+encodeURIComponent("Headlines")+"&range="+encodeURIComponent("A:C");
/* Prefetch hint */
try{var pl=document.createElement("link");pl.rel="prefetch";pl.href=HL_URL;pl.as="fetch";pl.crossOrigin="anonymous";document.head.appendChild(pl);}catch(_){}

/* ===== CSV parse (quotes, commas, CRLF) ===== */
function parseCsv(t){var rows=[],row=[],cur="",inQ=!1,i,c;for(i=0;i<t.length;i++){c=t[i];if(inQ){if(c!=='"')cur+=c;else if(t[i+1]==='"'){cur+='"';i++;}else inQ=!1;}else if(c==='"')inQ=!0;else if(c===','){row.push(cur);cur="";}else if(c==='\n'){row.push(cur);rows.push(row);row=[];cur="";}else if(c!=='\r'){cur+=c;}}(cur.length||row.length)&&(row.push(cur),rows.push(row));return rows}

/* ===== Helpers ===== */
function setDur(el,items){try{var len=(items||[]).join(" • ").length||120,secs=Math.min(140,Math.max(60,Math.round(len/1.8)));el.style.setProperty("--dur",secs+"s");}catch(_){ }}
function renderTicker(el,items,dir){if(!el)return;el.className="ticker "+(dir==="right"?"ticker-right":"ticker-left")+" "+(el.id==="botTicker"?"text-sm text-slate-700":"text-sm font-medium");if(!items||!items.length)return;el.innerHTML="";var loop=items.concat(items),i;for(i=0;i<loop.length;i++){var s=document.createElement("span");s.textContent=loop[i];el.appendChild(s)}setDur(el,items)}
function reduceMotion(){try{if(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches){var els=document.querySelectorAll(".ticker-left,.ticker-right");for(var i=0;i<els.length;i++)els[i].style.animation="none";}}catch(_){ }}
function wireCopy(){document.addEventListener("click",function(e){var t=e.target||e.srcElement;if(!t||!t.getAttribute)return;var id=t.getAttribute("data-copy");if(!id)return;var el=document.getElementById(id),text=el?(el.innerText||el.textContent||""):"";if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(function(){var prev=t.textContent;t.textContent="Copied!";setTimeout(function(){t.textContent=prev},1200);}).catch(function(){});}});}
function setYear(){var y=(new Date).getFullYear().toString(),a=document.getElementById("year"),b=document.getElementById("yearA");if(a)a.textContent=y;if(b)b.textContent=y;}
function fetchWithTimeout(url,ms){return new Promise(function(res,rej){var to=setTimeout(function(){try{ctrl.abort()}catch(_){ }rej(new Error("timeout"));},ms||800),ctrl=("AbortController"in window)?new AbortController():null,opts=ctrl?{signal:ctrl.signal,cache:"force-cache",credentials:"omit"}:{cache:"force-cache",credentials:"omit"};fetch(url,opts).then(function(r){clearTimeout(to);res(r)}).catch(function(e){clearTimeout(to);rej(e)})})}
function getHeadlines(){return fetchWithTimeout(HL_URL,800).then(function(r){if(!r.ok)throw new Error("HTTP "+r.status);return r.text()}).then(function(txt){if((txt||"").trim().indexOf("<")==0)return[];var rows=parseCsv(txt);if(!rows.length)return[];var hdr=rows[0].map(function(h){return h.replace(/^\uFEFF/,"").trim().toLowerCase()}),iS=hdr.indexOf("section"),iT=hdr.indexOf("text");if(iS<0||iT<0)return[];return rows.slice(1).map(function(r){return{section:(r[iS]||"").toLowerCase().trim(),text:(r[iT]||"").trim()}}).filter(function(x){return !!x.text})}).catch(function(){return[]})}

/* Paint from data */
function paint(data){var top=[],bot=[],i;for(i=0;i<data.length;i++){var r=data[i];if(r.section==="top")top.push(r.text);else if(r.section==="bottom")bot.push(r.text);}var tEl=document.getElementById("topTicker"), bEl=document.getElementById("botTicker");if(top.length)renderTicker(tEl,top,"right");if(bot.length)renderTicker(bEl,bot,"left");}

/* ===== Boot ===== */
function hydrate(){getHeadlines().then(function(d){paint(d);}).then(function(){/* retry once soon in case Sheet warmed late */setTimeout(function(){getHeadlines().then(paint);},2000);});}
function boot(){setYear();reduceMotion();wireCopy();hydrate();/* refresh every 5 min */setInterval(hydrate,300000);/* refresh when tab gets focus */document.addEventListener("visibilitychange",function(){if(!document.hidden)hydrate()});}
document.addEventListener("DOMContentLoaded",boot);
}();
